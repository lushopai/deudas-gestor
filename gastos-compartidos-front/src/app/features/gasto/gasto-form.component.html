<mat-toolbar color="primary">
  <button mat-icon-button (click)="volver()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span>{{ modoEdicion ? 'Editar Gasto' : 'Registrar Gasto' }}</span>
</mat-toolbar>

<div class="form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ modoEdicion ? 'Editar Gasto' : 'Nuevo Gasto' }}</mat-card-title>
      <mat-card-subtitle>{{ modoEdicion ? 'Actualiza la informaci√≥n' : 'Manual o con OCR' }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group class="tabs-container" [(selectedIndex)]="selectedTabIndex">
        <!-- Pesta√±a: Ingreso Manual -->
        <mat-tab label="Ingreso Manual">
          <div class="tab-content">
            <form [formGroup]="formulario" (ngSubmit)="guardarGasto()">
              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Descripci√≥n</mat-label>
                <input matInput formControlName="descripcion" placeholder="Ej: Almuerzo, Supermercado..." required>
                <mat-icon matPrefix>description</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Monto</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto" placeholder="0.00" required>
                <mat-icon matPrefix>attach_money</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Categor√≠a</mat-label>
                <mat-select formControlName="categoriaId" required>
                  <mat-select-trigger *ngIf="getCategoria(formulario.get('categoriaId')?.value) as cat">
                    {{ cat?.icono }} {{ cat?.nombre }}
                  </mat-select-trigger>
                  <mat-option *ngFor="let cat of categorias" [value]="cat.id">
                    {{ cat.icono }} {{ cat.nombre }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>category</mat-icon>
              </mat-form-field>

              <button mat-raised-button color="primary" type="submit" class="full-width submit-btn" [disabled]="cargando">
                <mat-icon *ngIf="!cargando">save</mat-icon>
                <mat-progress-spinner *ngIf="cargando" diameter="24" mode="indeterminate"></mat-progress-spinner>
                {{ cargando ? 'Guardando...' : (modoEdicion ? 'ACTUALIZAR GASTO' : 'GUARDAR GASTO') }}
              </button>
            </form>
          </div>
        </mat-tab>

        <!-- Pesta√±a: Escanear Recibo -->
        <mat-tab label="Escanear Recibo">
          <div class="tab-content">
            <div class="ocr-container">
              <!-- Consejos para mejor escaneo - Versi√≥n minimalista -->
              <mat-card class="tips-card">
                <mat-card-content>
                  <div class="tips-header">
                    <mat-icon color="primary">lightbulb_outline</mat-icon>
                    <span class="tips-title">Tips</span>
                  </div>
                  <ul class="tips-list">
                    <li>Buena iluminaci√≥n y superficie plana</li>
                    <li>Centra y enfoca el recibo</li>
                  </ul>
                </mat-card-content>
              </mat-card>

              <div class="scan-options">
                <!-- Opci√≥n 1: C√°mara -->
                <input #cameraInput type="file" accept="image/*" capture="environment" hidden (change)="onFileSelected($event)">
                <button 
                  mat-raised-button 
                  color="primary"
                  class="scan-btn camera-btn"
                  (click)="cameraInput.click()" 
                  [disabled]="procesandoOcr">
                  <mat-icon>photo_camera</mat-icon>
                  Tomar Foto
                </button>

                <!-- Opci√≥n 2: Galer√≠a -->
                <input #fileInput type="file" accept="image/*" hidden (change)="onFileSelected($event)">
                <button 
                  mat-stroked-button 
                  class="scan-btn gallery-btn"
                  (click)="fileInput.click()" 
                  [disabled]="procesandoOcr">
                  <mat-icon>image</mat-icon>
                  Galer√≠a
                </button>
              </div>

              <div *ngIf="procesandoOcr" class="processing-indicator">
                <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
                <span>ü§ñ Procesando con Llama Vision AI...</span>
                <small class="processing-hint">Analizando imagen con inteligencia artificial...</small>
              </div>

              <!-- Resultado del OCR -->
              <div *ngIf="resultadoOcr" class="ocr-result">
                <div class="result-header">
                  <h3 class="result-title">‚úì Datos Extra√≠dos del Recibo</h3>
                  <span class="motor-badge" [class.gemini]="resultadoOcr.motor === 'gemini'" [class.tesseract]="resultadoOcr.motor === 'tesseract'">
                    {{ resultadoOcr.motor === 'gemini' ? 'ü¶ô Llama AI' : 'üìù Tesseract' }}
                  </span>
                </div>

                <!-- TABLA DE ITEMS PRIMERO (m√°s prominente) -->
                <div class="items-section" *ngIf="itemsDetalle && itemsDetalle.length > 0">
                  <div class="section-header">
                    <h4>üõí Productos Detectados</h4>
                    <small>Elimina los que no correspondan</small>
                  </div>
                  
                  <div class="items-table-wrapper">
                    <table class="items-table">
                      <thead>
                        <tr>
                          <th>Producto</th>
                          <th class="text-right">Precio</th>
                          <th class="text-center">Acci√≥n</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of itemsDetalle; let i = index" class="item-row">
                          <td class="item-name">{{ item.nombre }}</td>
                          <td class="item-price text-right">\${{ item.precio | number:'1.0-2' }}</td>
                          <td class="item-actions text-center">
                            <button 
                              mat-icon-button 
                              color="warn" 
                              (click)="eliminarItem(i)" 
                              matTooltip="Eliminar"
                              class="delete-btn">
                              <mat-icon>close</mat-icon>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>TOTAL</strong></td>
                          <td class="text-right"><strong>\${{ formulario.get('monto')?.value | number:'1.0-2' }}</strong></td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

                <!-- Datos adicionales (colapsados visualmente) -->
                <details class="additional-data" open>
                  <summary>üìã Informaci√≥n Adicional</summary>
                  <div class="data-grid">
                    <div class="data-item" *ngIf="resultadoOcr.datos?.comercio">
                      <mat-icon>store</mat-icon>
                      <div>
                        <small>Comercio</small>
                        <p>{{ resultadoOcr.datos.comercio }}</p>
                      </div>
                    </div>
                    <div class="data-item" *ngIf="resultadoOcr.datos?.fecha">
                      <mat-icon>calendar_today</mat-icon>
                      <div>
                        <small>Fecha</small>
                        <p>{{ resultadoOcr.datos.fecha }}</p>
                      </div>
                    </div>
                    <div class="data-item" *ngIf="resultadoOcr.datos?.tipoDocumento">
                      <mat-icon>receipt</mat-icon>
                      <div>
                        <small>Tipo</small>
                        <p>{{ resultadoOcr.datos.tipoDocumento }}</p>
                      </div>
                    </div>
                    <div class="data-item">
                      <mat-icon>analytics</mat-icon>
                      <div>
                        <small>Confianza</small>
                        <p 
                          [class.alta]="resultadoOcr.confianza > 70"
                          [class.media]="resultadoOcr.confianza > 40 && resultadoOcr.confianza <= 70"
                          [class.baja]="resultadoOcr.confianza <= 40">
                          {{ resultadoOcr.confianza }}%
                        </p>
                      </div>
                    </div>
                  </div>
                </details>

                <mat-divider class="result-divider"></mat-divider>

                <h4 class="edit-title">‚úèÔ∏è Revisa y Guarda</h4>
                <form [formGroup]="formulario" (ngSubmit)="guardarGasto()">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Descripci√≥n</mat-label>
                    <input matInput formControlName="descripcion" required>
                    <mat-icon matPrefix>description</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Monto</mat-label>
                    <input matInput type="number" step="0.01" formControlName="monto" required>
                    <mat-icon matPrefix>attach_money</mat-icon>
                    <mat-hint *ngIf="itemsDetalle && itemsDetalle.length > 0">
                      Calculado autom√°ticamente desde los items
                    </mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Categor√≠a</mat-label>
                    <mat-select formControlName="categoriaId" required>
                      <mat-option *ngFor="let cat of categorias" [value]="cat.id">
                        {{ cat.icono }} {{ cat.nombre }}
                      </mat-option>
                    </mat-select>
                    <mat-icon matPrefix>category</mat-icon>
                  </mat-form-field>

                  <div class="button-group">
                    <button mat-raised-button color="primary" type="submit" class="save-btn" [disabled]="cargando || formulario.invalid">
                      <mat-icon *ngIf="!cargando">save</mat-icon>
                      <mat-progress-spinner *ngIf="cargando" diameter="20" mode="indeterminate"></mat-progress-spinner>
                      {{ cargando ? 'Guardando...' : 'GUARDAR GASTO' }}
                    </button>
                    <button mat-stroked-button (click)="limpiarOCR()" type="button" class="clear-btn">
                      <mat-icon>refresh</mat-icon>
                      Escanear Otro
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
