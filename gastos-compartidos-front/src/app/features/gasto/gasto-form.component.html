<mat-toolbar color="primary">
  <button mat-icon-button (click)="volver()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span>{{ modoEdicion ? 'Editar Gasto' : 'Registrar Gasto' }}</span>
</mat-toolbar>

<div class="form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ modoEdicion ? 'Editar Gasto' : 'Nuevo Gasto' }}</mat-card-title>
      <mat-card-subtitle>{{ modoEdicion ? 'Modifica los datos del gasto' : 'Ingresa un gasto manualmente o escanea un recibo' }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group class="tabs-container" [(selectedIndex)]="selectedTabIndex">
        <!-- Pesta√±a: Ingreso Manual -->
        <mat-tab label="Ingreso Manual">
          <div class="tab-content">
            <form [formGroup]="formulario" (ngSubmit)="guardarGasto()">
              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Descripci√≥n</mat-label>
                <input matInput formControlName="descripcion" placeholder="Ej: Almuerzo, Supermercado..." required>
                <mat-icon matPrefix>description</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Monto</mat-label>
                <input matInput type="number" step="0.01" formControlName="monto" placeholder="0.00" required>
                <mat-icon matPrefix>attach_money</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="fill" class="full-width">
                <mat-label>Categor√≠a</mat-label>
                <mat-select formControlName="categoriaId" required>
                  <mat-select-trigger *ngIf="getCategoria(formulario.get('categoriaId')?.value) as cat">
                    {{ cat?.icono }} {{ cat?.nombre }}
                  </mat-select-trigger>
                  <mat-option *ngFor="let cat of categorias" [value]="cat.id">
                    {{ cat.icono }} {{ cat.nombre }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix>category</mat-icon>
              </mat-form-field>

              <button mat-raised-button color="primary" type="submit" class="full-width submit-btn" [disabled]="cargando">
                <mat-icon *ngIf="!cargando">save</mat-icon>
                <mat-progress-spinner *ngIf="cargando" diameter="24" mode="indeterminate"></mat-progress-spinner>
                {{ cargando ? 'Guardando...' : (modoEdicion ? 'ACTUALIZAR GASTO' : 'GUARDAR GASTO') }}
              </button>
            </form>
          </div>
        </mat-tab>

        <!-- Pesta√±a: Escanear Recibo -->
        <mat-tab label="Escanear Recibo">
          <div class="tab-content">
            <div class="ocr-container">
              <!-- Consejos para mejor escaneo -->
              <mat-card class="tips-card">
                <mat-card-content>
                  <div class="tips-header">
                    <mat-icon color="primary">tips_and_updates</mat-icon>
                    <span class="tips-title">Consejos para mejor resultado</span>
                  </div>
                  <ul class="tips-list">
                    <li>üì∏ Usa buena iluminaci√≥n (luz natural o blanca)</li>
                    <li>üìê Coloca el recibo sobre superficie plana</li>
                    <li>üéØ Centra el documento y enfoca bien</li>
                    <li>‚ú® Evita sombras y reflejos</li>
                  </ul>
                </mat-card-content>
              </mat-card>

              <div class="scan-options">
                <!-- Opci√≥n 1: C√°mara -->
                <input #cameraInput type="file" accept="image/*" capture="environment" hidden (change)="onFileSelected($event)">
                <button 
                  mat-raised-button 
                  color="primary"
                  class="scan-btn camera-btn"
                  (click)="cameraInput.click()" 
                  [disabled]="procesandoOcr">
                  <mat-icon>photo_camera</mat-icon>
                  Tomar Foto
                </button>

                <!-- Opci√≥n 2: Galer√≠a -->
                <input #fileInput type="file" accept="image/*" hidden (change)="onFileSelected($event)">
                <button 
                  mat-stroked-button 
                  class="scan-btn gallery-btn"
                  (click)="fileInput.click()" 
                  [disabled]="procesandoOcr">
                  <mat-icon>image</mat-icon>
                  Galer√≠a
                </button>
              </div>

              <div *ngIf="procesandoOcr" class="processing-indicator">
                <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
                <span>Procesando recibo...</span>
                <small class="processing-hint">Mejorando imagen y extrayendo datos...</small>
              </div>

              <!-- Resultado del OCR -->
              <div *ngIf="resultadoOcr" class="ocr-result">
                <h3 class="result-title">‚úì Datos Extra√≠dos del Recibo</h3>
                <div class="resultado-items">
                  <div class="resultado-item">
                    <strong>Monto detectado:</strong>
                    <span class="monto">\${{ resultadoOcr.datos?.cantidad || 'N/A' }}</span>
                  </div>
                  <div class="resultado-item">
                    <strong>Descripci√≥n:</strong>
                    <span>{{ resultadoOcr.datos?.descripcion || 'No especificada' }}</span>
                  </div>
                  <div class="resultado-item">
                    <strong>Confianza:</strong>
                    <span 
                      class="confianza"
                      [class.alta]="resultadoOcr.confianza > 70"
                      [class.media]="resultadoOcr.confianza > 40 && resultadoOcr.confianza <= 70"
                      [class.baja]="resultadoOcr.confianza <= 40"
                    >
                      {{ resultadoOcr.confianza }}%
                    </span>
                  </div>
                </div>

                <mat-divider class="result-divider"></mat-divider>

                <h4 class="edit-title">Edita los datos antes de guardar:</h4>
                <form [formGroup]="formulario" (ngSubmit)="guardarGasto()">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Descripci√≥n</mat-label>
                    <input matInput formControlName="descripcion" required>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Monto</mat-label>
                    <input matInput type="number" step="0.01" formControlName="monto" required>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Categor√≠a</mat-label>
                    <mat-select formControlName="categoriaId" required>
                      <mat-option *ngFor="let cat of categorias" [value]="cat.id">
                        {{ cat.icono }} {{ cat.nombre }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="button-group">
                    <button mat-raised-button color="primary" type="submit" class="full-width submit-btn" [disabled]="cargando">
                      <mat-icon *ngIf="!cargando">save</mat-icon>
                      <mat-progress-spinner *ngIf="cargando" diameter="24" mode="indeterminate"></mat-progress-spinner>
                      {{ cargando ? 'Guardando...' : (modoEdicion ? 'ACTUALIZAR GASTO' : 'GUARDAR GASTO') }}
                    </button>
                    <button mat-stroked-button (click)="limpiarOCR()" type="button" class="clear-btn">
                      <mat-icon>close</mat-icon>
                      Limpiar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>
