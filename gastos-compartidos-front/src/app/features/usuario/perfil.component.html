<!-- Header -->
<mat-toolbar color="primary" class="header">
  <div class="toolbar-content">
    <button mat-icon-button routerLink="/dashboard" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="logo">Mi Perfil</span>
    <span class="spacer"></span>
  </div>
</mat-toolbar>

<!-- Main Content -->
<div class="perfil-container">
  <!-- Loading State -->
  @if (cargando) {
    <div class="loading-state">
      <mat-spinner></mat-spinner>
    </div>
  }

  <!-- Error State -->
  @if (error && !cargando) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon class="error-icon">error_outline</mat-icon>
        <div class="error-message">{{ error }}</div>
        <button mat-button class="retry-btn" (click)="cargarPerfil()"
          style="margin-top: 10px; color: white; border: 1px solid white;">Reintentar</button>
      </mat-card-content>
    </mat-card>
  }

  <!-- Empty State fallback -->
  @if (!usuario && !cargando && !error) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-message">No hay datos de usuario disponibles.</div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Perfil Form -->
  @if (usuario && !cargando) {
    <form [formGroup]="perfilForm">
      <!-- Avatar Section -->
      <mat-card class="avatar-card">
        <mat-card-content class="avatar-content">
          <div class="avatar-container">
            @if (previewFoto) {
              <img [src]="previewFoto" alt="Avatar del usuario" class="avatar-image" />
            } @else {
              <div class="avatar-initials">
                {{ getInitials(usuario?.nombre) }}
              </div>
            }
            <button type="button" mat-fab color="primary" class="change-avatar-btn" (click)="seleccionarFoto()"
              title="Cambiar foto de perfil">
              <mat-icon>camera_alt</mat-icon>
            </button>
          </div>
          <div class="avatar-info">
            <h2 class="usuario-nombre">{{ usuario.nombre || 'Usuario' }}</h2>
            <p class="usuario-email">{{ usuario.email }}</p>
            @if (usuario.provider) {
              <p class="usuario-tipo">
                @if (usuario.provider === 'GOOGLE') {
                  <mat-icon>verified_user</mat-icon>
                }
                Registrado con {{ usuario.provider }}
              </p>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Información Personal -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-card-title>Información Personal</mat-card-title>
        </mat-card-header>
        <mat-divider></mat-divider>
        <mat-card-content class="form-content">
          <!-- Nombre -->
          <mat-form-field class="form-field">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombre" type="text" placeholder="Tu nombre completo" />
            <mat-icon matIconPrefix>person</mat-icon>
            @if (perfilForm.get('nombre')?.hasError('required')) {
              <mat-error>El nombre es requerido</mat-error>
            }
            @if (perfilForm.get('nombre')?.hasError('minlength')) {
              <mat-error>Mínimo 3 caracteres</mat-error>
            }
          </mat-form-field>

          <!-- Email (solo lectura) -->
          <mat-form-field class="form-field">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" />
            <mat-icon matIconPrefix>email</mat-icon>
            <mat-hint>No se puede cambiar el email</mat-hint>
          </mat-form-field>

          <!-- Teléfono -->
          <mat-form-field class="form-field">
            <mat-label>Teléfono (opcional)</mat-label>
            <input matInput formControlName="telefono" type="tel" placeholder="+56 9 1234 5678" />
            <mat-icon matIconPrefix>phone</mat-icon>
          </mat-form-field>

          <!-- Biografía -->
          <mat-form-field class="form-field form-field-textarea">
            <mat-label>Biografía</mat-label>
            <textarea matInput formControlName="bio" rows="4" placeholder="Cuéntanos un poco sobre ti"></textarea>
            <mat-icon matIconPrefix>description</mat-icon>
            <mat-hint align="end">{{ perfilForm.get('bio')?.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Información de Seguridad -->
      <mat-card class="info-card">
        <mat-card-header>
          <mat-card-title>Seguridad</mat-card-title>
        </mat-card-header>
        <mat-divider></mat-divider>
        <mat-card-content class="security-content">
          <div class="security-item">
            <div class="security-info">
              <mat-icon>security</mat-icon>
              <div class="security-text">
                <div class="security-label">Contraseña</div>
                @if (usuario.provider === 'GOOGLE') {
                  <div class="security-detail">Gestionada por Google</div>
                } @else {
                  <div class="security-detail">Última actualización: {{ usuario.fechaActualizacion | date: 'dd/MM/yyyy' }}</div>
                }
              </div>
            </div>
            @if (usuario.provider !== 'GOOGLE') {
              <button mat-stroked-button type="button" (click)="toggleFormPassword()">
                {{ mostrarFormPassword ? 'Cancelar' : 'Cambiar' }}
              </button>
            }
          </div>

          <!-- Formulario de cambio de contraseña -->
          @if (mostrarFormPassword) {
            <mat-divider></mat-divider>
            <div class="password-form-container" [formGroup]="passwordForm">
              <!-- Contraseña actual -->
              <mat-form-field class="form-field">
                <mat-label>Contraseña actual</mat-label>
                <input matInput formControlName="passwordActual"
                  [type]="hidePasswordActual ? 'password' : 'text'" />
                <mat-icon matIconPrefix>lock</mat-icon>
                <button mat-icon-button matSuffix type="button"
                  (click)="hidePasswordActual = !hidePasswordActual">
                  <mat-icon>{{ hidePasswordActual ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                @if (passwordForm.get('passwordActual')?.hasError('required') && passwordForm.get('passwordActual')?.touched) {
                  <mat-error>La contraseña actual es requerida</mat-error>
                }
              </mat-form-field>

              <!-- Nueva contraseña -->
              <mat-form-field class="form-field">
                <mat-label>Nueva contraseña</mat-label>
                <input matInput formControlName="passwordNueva"
                  [type]="hidePasswordNueva ? 'password' : 'text'" />
                <mat-icon matIconPrefix>lock_reset</mat-icon>
                <button mat-icon-button matSuffix type="button"
                  (click)="hidePasswordNueva = !hidePasswordNueva">
                  <mat-icon>{{ hidePasswordNueva ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                @if (passwordForm.get('passwordNueva')?.hasError('required') && passwordForm.get('passwordNueva')?.touched) {
                  <mat-error>La nueva contraseña es requerida</mat-error>
                } @else if (passwordForm.get('passwordNueva')?.hasError('minlength') && passwordForm.get('passwordNueva')?.touched) {
                  <mat-error>Mínimo 8 caracteres</mat-error>
                } @else if (passwordForm.get('passwordNueva')?.hasError('pattern') && passwordForm.get('passwordNueva')?.touched) {
                  <mat-error>Debe incluir mayúscula, minúscula, número y carácter especial</mat-error>
                }
              </mat-form-field>

              <!-- Confirmar contraseña -->
              <mat-form-field class="form-field">
                <mat-label>Confirmar contraseña</mat-label>
                <input matInput formControlName="confirmarPassword"
                  [type]="hideConfirmar ? 'password' : 'text'" />
                <mat-icon matIconPrefix>check_circle</mat-icon>
                <button mat-icon-button matSuffix type="button"
                  (click)="hideConfirmar = !hideConfirmar">
                  <mat-icon>{{ hideConfirmar ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                @if (passwordForm.get('confirmarPassword')?.hasError('required') && passwordForm.get('confirmarPassword')?.touched) {
                  <mat-error>Confirma tu nueva contraseña</mat-error>
                } @else if (passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmarPassword')?.touched) {
                  <mat-error>Las contraseñas no coinciden</mat-error>
                }
              </mat-form-field>

              <div class="password-actions">
                <button mat-raised-button color="primary" type="button"
                  (click)="cambiarPassword()"
                  [disabled]="guardandoPassword || passwordForm.invalid">
                  @if (guardandoPassword) {
                    <mat-progress-spinner diameter="20" mode="indeterminate" class="spinner"></mat-progress-spinner>
                  }
                  {{ guardandoPassword ? 'Guardando...' : 'Guardar Contraseña' }}
                </button>
                <button mat-stroked-button type="button" (click)="toggleFormPassword()"
                  [disabled]="guardandoPassword">
                  Cancelar
                </button>
              </div>
            </div>
          }

          <mat-divider></mat-divider>
          <div class="security-item">
            <div class="security-info">
              <mat-icon>verified_user</mat-icon>
              <div class="security-text">
                <div class="security-label">Autenticación de dos factores</div>
                <div class="security-detail">No configurada</div>
              </div>
            </div>
            <button mat-stroked-button type="button" [disabled]="true">
              Configurar
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button mat-raised-button color="primary" (click)="guardarCambios()" [disabled]="guardando || perfilForm.invalid"
          class="save-btn">
          @if (!guardando) {
            <mat-icon>save</mat-icon>
          }
          @if (guardando) {
            <mat-progress-spinner diameter="20" mode="indeterminate" class="spinner"></mat-progress-spinner>
          }
          {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
        <button mat-stroked-button (click)="cancelar()" [disabled]="guardando" class="cancel-btn">
          Cancelar
        </button>
      </div>
    </form>
  }
</div>
