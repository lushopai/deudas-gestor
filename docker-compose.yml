services:
  # Nginx Reverse Proxy (punto de entrada único para ngrok)
  nginx:
    image: nginx:alpine
    container_name: gastos_nginx
    ports:
      - "8888:80" # Puerto único expuesto - usar con: ngrok http 8888
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - app_network
    restart: unless-stopped

  # Backend Spring Boot
  backend:
    build:
      context: ./gastos-compartidos
      dockerfile: Dockerfile
    container_name: gastos_backend
    # Puerto NO expuesto externamente, solo dentro de la red Docker
    expose:
      - "8080"
    environment:
      # Zona horaria Chile
      TZ: America/Santiago
      
      # Perfil de Spring Boot (prod = logs optimizados)
      SPRING_PROFILES_ACTIVE: prod

      # CONECTAR A BASE DE DATOS EXTERNA (desde .env)
      SPRING_DATASOURCE_URL: ${DATABASE_URL}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME:-admin}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # Autenticación y Secretos (Se inyectan desde el servidor/Jenkins)
      APP_JWT_SECRET: ${JWT_SECRET}
      JWT_SECRET: ${JWT_SECRET} # Necesario para application-prod.properties
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

      # Notificaciones Push (VAPID)
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}

      # Configuración de CORS (IMPORTANTE: Usar ALLOWED_ORIGINS, no CORS_ALLOWED_ORIGINS)
      # Para ngrok: https://*.ngrok-free.app,https://*.ngrok.app
      # O específica: https://0027-2803-c600-7115-c592-ddd0-8191-263f-46ea.ngrok-free.app
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

      # Claude Vision OCR
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
    networks:
      - app_network
    restart: unless-stopped

  # Frontend Angular
  frontend:
    build:
      context: ./gastos-compartidos-front
      dockerfile: Dockerfile
    container_name: gastos_frontend
    # Puerto NO expuesto externamente, solo dentro de la red Docker
    expose:
      - "80"
    depends_on:
      - backend
    networks:
      - app_network
    restart: unless-stopped


volumes:
  postgres_data_root:
  pgadmin_data_root:


networks:
  app_network:
    driver: bridge
